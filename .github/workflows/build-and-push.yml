name: Docker Build and Push

# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒã„ã¤å®Ÿè¡Œã•ã‚Œã‚‹ã‹ã‚’å®šç¾©
on:
  push:
    branches: [ main, develop ]    # mainã¾ãŸã¯developãƒ–ãƒ©ãƒ³ãƒã«pushã•ã‚ŒãŸæ™‚
    tags: [ 'v*' ]                # v1.0.0ã®ã‚ˆã†ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ã‚°ãŒä½œæˆã•ã‚ŒãŸæ™‚
  pull_request:
    branches: [ main ]             # mainãƒ–ãƒ©ãƒ³ãƒã«å¯¾ã™ã‚‹ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒä½œæˆ/æ›´æ–°ã•ã‚ŒãŸæ™‚
    types: [opened, synchronize, reopened]  # æ–°è¦ä½œæˆãƒ»åŒæœŸãƒ»å†ã‚ªãƒ¼ãƒ—ãƒ³æ™‚
  schedule:
    - cron: '0 2 * * 0'            # æ¯é€±æ—¥æ›œæ—¥2æ™‚ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œ

# å…¨ã¦ã®ã‚¸ãƒ§ãƒ–ã§å…±é€šã—ã¦ä½¿ç”¨ã™ã‚‹ç’°å¢ƒå¤‰æ•°ã‚’å®šç¾©
env:
  REGISTRY: ghcr.io              # GitHub Container Registryï¼ˆGitHubãŒæä¾›ã™ã‚‹Dockerãƒ¬ã‚¸ã‚¹ãƒˆãƒªï¼‰
  IMAGE_NAME: leCielEtoile/discord-bot-r2  # ã‚¤ãƒ¡ãƒ¼ã‚¸å
  # å…±é€šè¨­å®šã‚’ç’°å¢ƒå¤‰æ•°ã§ä¸€å…ƒç®¡ç†ã™ã‚‹ã“ã¨ã§ã€ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§ã‚’å‘ä¸Š
  PLATFORMS: linux/amd64,linux/arm64    # ãƒ“ãƒ«ãƒ‰å¯¾è±¡ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ï¼ˆIntel/AMD64ã¨ARM64ï¼‰

  BUILDKIT_PROGRESS: plain    # è©³ç´°ã§ä¸€è²«æ€§ã®ã‚ã‚‹ãƒ­ã‚°å‡ºåŠ›
  
  # ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ï¼šGitHub Actionsã¨Container Registryã®ä¸¡æ–¹ã‚’æ´»ç”¨
  CACHE_FROM: |
    type=gha
    type=registry,ref=ghcr.io/lecielotoile/discord-bot-r2:buildcache
  CACHE_TO: |
    type=gha,mode=max
    type=registry,ref=ghcr.io/lecielotoile/discord-bot-r2:buildcache,mode=max

# å®Ÿè¡Œã•ã‚Œã‚‹å‡¦ç†ã®å˜ä½ï¼ˆã‚¸ãƒ§ãƒ–ï¼‰ã‚’å®šç¾©
jobs:
  # ã€ã‚¸ãƒ§ãƒ–1ã€‘å¤‰æ›´æ¤œå‡º - ç„¡é§„ãªãƒ“ãƒ«ãƒ‰ã‚’é¿ã‘ã‚‹ãŸã‚ã«ä½•ãŒå¤‰æ›´ã•ã‚ŒãŸã‹ã‚’ãƒã‚§ãƒƒã‚¯
  changes:
    runs-on: ubuntu-latest        # Ubuntuç’°å¢ƒã§å®Ÿè¡Œ
    # ã“ã®ã‚¸ãƒ§ãƒ–ã®å‡ºåŠ›çµæœã‚’ä»–ã®ã‚¸ãƒ§ãƒ–ã§ä½¿ç”¨ã§ãã‚‹ã‚ˆã†ã«å®šç¾©
    outputs:
      docker: ${{ steps.changes.outputs.docker }}      # Dockerãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚ŒãŸã‹
      workflow: ${{ steps.changes.outputs.workflow }}  # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚ŒãŸã‹
    steps:
    # ã‚¹ãƒ†ãƒƒãƒ—1: ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    - uses: actions/checkout@v4
    # ã‚¹ãƒ†ãƒƒãƒ—2: ã©ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚ŒãŸã‹ã‚’æ¤œå‡º
    - uses: dorny/paths-filter@v3
      id: changes
      with:
        # å¤‰æ›´ã‚’ç›£è¦–ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å®šç¾©
        filters: |
          docker:
            - 'bot/**'
            - 'Dockerfile'
            - 'requirements.txt'
            - 'entrypoint.sh'
          workflow:
            - '.github/workflows/**'

  # ã€ã‚¸ãƒ§ãƒ–2ã€‘äº‹å‰ãƒã‚§ãƒƒã‚¯ - ãƒ“ãƒ«ãƒ‰ãŒæœ¬å½“ã«å¿…è¦ã‹ã‚’ç´ æ—©ãåˆ¤æ–­
  pre-checks:
    runs-on: ubuntu-latest
    needs: changes                # changesã‚¸ãƒ§ãƒ–ã®å®Œäº†ã‚’å¾…ã¤
    # Dockeré–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã€ã¾ãŸã¯pushã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆã®ã¿å®Ÿè¡Œ
    if: needs.changes.outputs.docker == 'true' || github.event_name == 'push'
    outputs:
      should-build: ${{ steps.check.outputs.should-build }}  # ãƒ“ãƒ«ãƒ‰ã™ã¹ãã‹ã®åˆ¤å®šçµæœ
      cache-key: ${{ steps.cache-key.outputs.key }}          # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼
    steps:
    - uses: actions/checkout@v4
    
    # ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã‹ã‚‰ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã‚’ç”Ÿæˆ
    - name: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ç”Ÿæˆ
      id: cache-key
      # Dockerfileã¨é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’ãƒãƒƒã‚·ãƒ¥åŒ–ã—ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã‚’ä½œæˆ
      # åŒã˜å†…å®¹ãªã‚‰åŒã˜ã‚­ãƒ¼ã«ãªã‚‹ã®ã§ã€é‡è¤‡ãƒ“ãƒ«ãƒ‰ã‚’é¿ã‘ã‚‰ã‚Œã‚‹
      run: |
        HASH=$(find . -name "Dockerfile" -o -name "requirements.txt" -o -name "entrypoint.sh" | \
               xargs cat | sha256sum | cut -d' ' -f1 | head -c 8)
        echo "key=docker-${HASH}-${{ github.sha }}" >> $GITHUB_OUTPUT
    
    # ã‚¹ãƒ†ãƒƒãƒ—2: åŒã˜å†…å®¹ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    - name: æ—¢å­˜ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒã‚§ãƒƒã‚¯
      id: check
      # Container Registryã«åŒã˜ã‚­ãƒ¼ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒã‚ã‚‹ã‹ã‚’ç¢ºèª
      run: |
        if docker manifest inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.cache-key.outputs.key }} >/dev/null 2>&1; then
          echo "should-build=false" >> $GITHUB_OUTPUT
          echo "âœ… Image with same content already exists, skipping build"
        else
          echo "should-build=true" >> $GITHUB_OUTPUT
          echo "ğŸ”¨ New build required"
        fi

  # ã€ã‚¸ãƒ§ãƒ–3ã€‘ãƒ“ãƒ«ãƒ‰ - Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’è¤‡æ•°ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å‘ã‘ã«ãƒ“ãƒ«ãƒ‰
  build:
    runs-on: ${{ matrix.runner }}  # ãƒãƒˆãƒªãƒƒã‚¯ã‚¹ãƒ™ãƒ¼ã‚¹ã®ãƒ©ãƒ³ãƒŠãƒ¼é¸æŠ
    needs: [changes, pre-checks]   # å‰ã®2ã¤ã®ã‚¸ãƒ§ãƒ–ã®å®Œäº†ã‚’å¾…ã¤
    # äº‹å‰ãƒã‚§ãƒƒã‚¯ã§ãƒ“ãƒ«ãƒ‰ãŒå¿…è¦ã¨åˆ¤å®šã•ã‚ŒãŸå ´åˆã®ã¿å®Ÿè¡Œ
    if: needs.pre-checks.outputs.should-build == 'true'
    strategy:
      fail-fast: false           # ä¸€ã¤ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§å¤±æ•—ã—ã¦ã‚‚ä»–ã‚’ç¶šè¡Œ
      matrix:
        include:
          # ãƒã‚¤ãƒ†ã‚£ãƒ–ARM64ãƒ©ãƒ³ãƒŠãƒ¼ã§ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
          - platform: linux/amd64
            runner: ubuntu-latest
          - platform: linux/arm64
            runner: ubuntu-24.04-arm64  # ARM64å°‚ç”¨ãƒ©ãƒ³ãƒŠãƒ¼ï¼ˆ2024å¹´å¯¾å¿œï¼‰
    # ã“ã®ã‚¸ãƒ§ãƒ–ã§å¿…è¦ãªGitHubæ¨©é™ã‚’å®šç¾©
    permissions:
      contents: read            # ãƒªãƒã‚¸ãƒˆãƒªã®èª­ã¿å–ã‚Š
      packages: write          # Container Registryã¸ã®æ›¸ãè¾¼ã¿
      actions: read           # ä»–ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®çŠ¶æ³ç¢ºèª
      id-token: write         # OIDCèªè¨¼ç”¨ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼‰
      attestations: write     # è¨¼æ˜æ›¸ä½œæˆç”¨
    # ã“ã®ã‚¸ãƒ§ãƒ–ã®å‡ºåŠ›ã‚’ä»–ã®ã‚¸ãƒ§ãƒ–ã§ä½¿ç”¨ã§ãã‚‹ã‚ˆã†ã«å®šç¾©
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}        # ãƒ“ãƒ«ãƒ‰ã—ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆ
      image-metadata: ${{ steps.meta.outputs.json }}         # ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
    
    steps:
    # ã‚¹ãƒ†ãƒƒãƒ—1: ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
    
    # ã‚¹ãƒ†ãƒƒãƒ—2: Docker Buildxã®è¨­å®š
    - name: Docker Buildx ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: docker/setup-buildx-action@v3
      with:
        platforms: ${{ matrix.platform }}  # ç¾åœ¨ã®ãƒãƒˆãƒªãƒƒã‚¯ã‚¹ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®ã¿
        # å®‰å®šç‰ˆã‚’å›ºå®šä½¿ç”¨ï¼ˆ2024å¹´12æœˆæœ€æ–°å®‰å®šç‰ˆï¼‰
        driver-opts: |
          image=moby/buildkit:v0.16.0
    
    # ã‚¹ãƒ†ãƒƒãƒ—3: GitHub Container Registryã«ãƒ­ã‚°ã‚¤ãƒ³
    - name: Container Registry ãƒ­ã‚°ã‚¤ãƒ³
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}          # GitHubã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å
        password: ${{ secrets.GITHUB_TOKEN }}  # GitHubãŒè‡ªå‹•ã§æä¾›ã™ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³
        logout: false                          # ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚’ç„¡åŠ¹åŒ–ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šï¼‰
    
    # ã‚¹ãƒ†ãƒƒãƒ—4: ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚¿ã‚°ã€ãƒ©ãƒ™ãƒ«ç­‰ï¼‰ã‚’ç”Ÿæˆ
    - name: ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æŠ½å‡º
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        # ã‚¿ã‚°ã®å‘½åè¦å‰‡ã‚’è¨­å®š
        flavor: |
          latest=auto                          # è‡ªå‹•ã§latestã‚¿ã‚°ã‚’ä»˜ä¸
        # æ§˜ã€…ãªæ¡ä»¶ã«å¿œã˜ãŸã‚¿ã‚°ç”Ÿæˆè¦å‰‡
        tags: |
          type=ref,event=branch                # ãƒ–ãƒ©ãƒ³ãƒåãƒ™ãƒ¼ã‚¹ã®ã‚¿ã‚°
          type=ref,event=pr,prefix=pr-         # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆç”¨ã®ã‚¿ã‚°ï¼ˆpr-123ãªã©ï¼‰
          type=semver,pattern={{version}}      # ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆv1.2.3ï¼‰
          type=semver,pattern={{major}}.{{minor}} # ãƒ¡ã‚¸ãƒ£ãƒ¼.ãƒã‚¤ãƒŠãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆ1.2ï¼‰
          type=semver,pattern={{major}}        # ãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã¿ï¼ˆ1ï¼‰
          type=sha,prefix={{branch}}-,format=short # ãƒ–ãƒ©ãƒ³ãƒå+çŸ­ã„SHAï¼ˆmain-abc1234ï¼‰
          type=raw,value=latest,enable={{is_default_branch}} # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ–ãƒ©ãƒ³ãƒã«latest
        # OCIä»•æ§˜ã«æº–æ‹ ã—ãŸãƒ©ãƒ™ãƒ«ï¼ˆã‚¤ãƒ¡ãƒ¼ã‚¸ã®è©³ç´°æƒ…å ±ï¼‰
        labels: |
          org.opencontainers.image.title=Discord YouTube Downloader Bot
          org.opencontainers.image.description=High-performance Discord bot for downloading YouTube videos to Cloudflare R2 storage
          org.opencontainers.image.vendor=leCielEtoile
          org.opencontainers.image.source=https://github.com/${{ github.repository }}
          org.opencontainers.image.documentation=https://github.com/${{ github.repository }}/blob/main/README.md
          org.opencontainers.image.licenses=BSD-3-Clause
    
    # ã‚¹ãƒ†ãƒƒãƒ—5: å®Ÿéš›ã®Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã¨ãƒ—ãƒƒã‚·ãƒ¥
    - name: ãƒ“ãƒ«ãƒ‰ï¼†ãƒ—ãƒƒã‚·ãƒ¥
      id: build
      uses: docker/build-push-action@v6
      with:
        context: .                              # ãƒ“ãƒ«ãƒ‰ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼‰
        platforms: ${{ matrix.platform }}      # ãƒ“ãƒ«ãƒ‰å¯¾è±¡ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ 
        push: true                              # ãƒ“ãƒ«ãƒ‰å¾Œã«ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã«ãƒ—ãƒƒã‚·ãƒ¥
        tags: ${{ steps.meta.outputs.tags }}   # ç”Ÿæˆã•ã‚ŒãŸã‚¿ã‚°ã‚’é©ç”¨
        labels: ${{ steps.meta.outputs.labels }} # ç”Ÿæˆã•ã‚ŒãŸãƒ©ãƒ™ãƒ«ã‚’é©ç”¨
        # ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®šï¼šãƒ“ãƒ«ãƒ‰æ™‚é–“ã‚’å¤§å¹…çŸ­ç¸®
        cache-from: ${{ env.CACHE_FROM }}       # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®èª­ã¿è¾¼ã¿å…ƒ
        cache-to: ${{ env.CACHE_TO }}           # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ä¿å­˜å…ˆ
        # ãƒ“ãƒ«ãƒ‰æ™‚ã«æ¸¡ã•ã‚Œã‚‹å¼•æ•°
        build-args: |
          BUILD_DATE=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.created'] }}
          VCS_REF=${{ github.sha }}             # Gitã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥
          VERSION=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.version'] }}
          BUILDKIT_INLINE_CACHE=1               # ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹åŒ–
          ALPINE_VERSION=3.19.8                 # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒé©ç”¨ç‰ˆAlpine
        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£ã®å‘ä¸Š
        provenance: mode=max                    # ãƒ—ãƒ­ãƒ“ãƒŠãƒ³ã‚¹æƒ…å ±ã‚’æœ€å¤§é™è¨˜éŒ²
        sbom: true                              # SBOMï¼ˆSoftware Bill of Materialsï¼‰ã‚’ç”Ÿæˆ
        # ãƒ“ãƒ«ãƒ‰ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®æœ€é©åŒ–
        build-contexts: |
          alpine=docker-image://alpine:3.19.8    # ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥

  # ã€ã‚¸ãƒ§ãƒ–4ã€‘ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆä½œæˆ - è¤‡æ•°ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’çµ±åˆ
  create-manifest:
    runs-on: ubuntu-latest
    needs: build                   # buildã‚¸ãƒ§ãƒ–ã®å®Œäº†ã‚’å¾…ã¤
    # buildãŒæˆåŠŸã—ã€ã‹ã¤ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ãªã„å ´åˆã®ã¿å®Ÿè¡Œ
    if: always() && needs.build.result == 'success' && github.event_name != 'pull_request'
    permissions:
      contents: read
      packages: write
    
    steps:
    # Docker Buildxã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆä½œæˆç”¨ï¼‰
    - name: Docker Buildx ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: docker/setup-buildx-action@v3
    
    # Container Registryã«ãƒ­ã‚°ã‚¤ãƒ³
    - name: Container Registry ãƒ­ã‚°ã‚¤ãƒ³
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    # è¤‡æ•°ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’1ã¤ã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã«çµ±åˆ
    - name: ãƒãƒ«ãƒã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆä½œæˆ
      # ãƒ“ãƒ«ãƒ‰ã‚¸ãƒ§ãƒ–ã§ç”Ÿæˆã•ã‚ŒãŸãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã‚¿ã‚°ã‚’å–å¾—
      # å„ã‚¿ã‚°ã«å¯¾ã—ã¦ãƒãƒ«ãƒã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’ä½œæˆ
      run: |
        TAGS=$(echo '${{ needs.build.outputs.image-metadata }}' | jq -r '.tags[]' | head -5)
        
        for tag in $TAGS; do
          echo "Creating manifest for: $tag"
          # linux/amd64ã¨linux/arm64ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’çµ±åˆ
          docker buildx imagetools create -t "$tag" \
            "${tag}-linux-amd64" \
            "${tag}-linux-arm64"
        done

  # ã€ã‚¸ãƒ§ãƒ–5ã€‘ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— - 10GBåˆ¶é™å¯¾ç­–
  cache-cleanup:
    runs-on: ubuntu-latest
    # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œã¾ãŸã¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ‰‹å‹•å®Ÿè¡Œã®å ´åˆã®ã¿å®Ÿè¡Œ
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    permissions:
      actions: write              # ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤æ¨©é™
    
    steps:
    - name: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µã‚¤ã‚ºç›£è¦–ã¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
      run: |
        # GitHub CLI ã‚’ä½¿ç”¨ã—ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥æƒ…å ±ã‚’å–å¾—
        echo "ç¾åœ¨ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä½¿ç”¨çŠ¶æ³ã‚’ç¢ºèªä¸­..."
        
        # 7æ—¥ä»¥ä¸Šå¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤
        echo "7æ—¥ä»¥ä¸Šå¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤ä¸­..."
        gh cache list --limit 100 | grep -E "7 days ago|[0-9]+ weeks ago|[0-9]+ months ago" | \
        while read -r line; do
          cache_id=$(echo "$line" | awk '{print $1}')
          echo "Deleting cache: $cache_id"
          gh cache delete "$cache_id" || true
        done
        
        # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µã‚¤ã‚ºãŒ8GBä»¥ä¸Šã®å ´åˆã€å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å‰Šé™¤
        TOTAL_SIZE=$(gh cache list --limit 100 | awk '{sum += $3} END {print sum}')
        if [ "$TOTAL_SIZE" -gt 8000 ]; then
          echo "ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µã‚¤ã‚ºãŒ8GBã‚’è¶…éã€‚å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤ä¸­..."
          gh cache list --sort created-at --order asc --limit 10 | \
          while read -r line; do
            cache_id=$(echo "$line" | awk '{print $1}')
            echo "Deleting oldest cache: $cache_id"
            gh cache delete "$cache_id" || true
          done
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ã€ã‚¸ãƒ§ãƒ–6ã€‘é€šçŸ¥ - çµæœã‚’Slackã§é€šçŸ¥
  notify:
    runs-on: ubuntu-latest
    needs: [build, create-manifest]  # ä¸»è¦ã‚¸ãƒ§ãƒ–ã®å®Œäº†ã‚’å¾…ã¤
    if: always()                     # å¤±æ•—ã—ãŸå ´åˆã‚‚å«ã‚ã¦å¸¸ã«å®Ÿè¡Œ
    permissions:
      contents: read
    
    steps:
    - name: çµæœã‚µãƒãƒªãƒ¼ç”Ÿæˆ
      id: summary
      run: |
        # å„ã‚¸ãƒ§ãƒ–ã®çµæœã‚’å–å¾—
        BUILD_STATUS="${{ needs.build.result }}"
        MANIFEST_STATUS="${{ needs.create-manifest.result }}"
        
        # ç·åˆçµæœã‚’åˆ¤å®š
        if [[ "$BUILD_STATUS" == "success" ]]; then
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å ´åˆï¼šãƒ“ãƒ«ãƒ‰æˆåŠŸã§ååˆ†
            OVERALL="success"
            ICON="âœ…"
            MESSAGE="Build completed successfully"
          elif [[ "$MANIFEST_STATUS" == "success" ]]; then
            # æœ¬æ ¼çš„ãªãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ï¼šå…¨ã¦æˆåŠŸ
            OVERALL="success"
            ICON="ğŸ‰"
            MESSAGE="Complete pipeline executed successfully"
          else
            # ãƒ“ãƒ«ãƒ‰ã¯æˆåŠŸã—ãŸãŒã€å¾Œç¶šå‡¦ç†ã«å•é¡Œ
            OVERALL="partial"
            ICON="âš ï¸"
            MESSAGE="Build succeeded but post-processing had issues"
          fi
        else
          # ãƒ“ãƒ«ãƒ‰ã«å¤±æ•—
          OVERALL="failure"
          ICON="âŒ"
          MESSAGE="Build failed"
        fi
        
        # çµæœã‚’å‡ºåŠ›å¤‰æ•°ã«è¨­å®šï¼ˆå¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã§ä½¿ç”¨ï¼‰
        echo "overall=$OVERALL" >> $GITHUB_OUTPUT
        echo "icon=$ICON" >> $GITHUB_OUTPUT
        echo "message=$MESSAGE" >> $GITHUB_OUTPUT
    
    # Slackã«è©³ç´°ãªé€šçŸ¥ã‚’é€ä¿¡
    - name: Slack é€šçŸ¥ï¼ˆçµ±åˆï¼‰
      uses: 8398a7/action-slack@v3
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}  # ãƒªãƒã‚¸ãƒˆãƒªã®Secretsã§è¨­å®š
      if: env.SLACK_WEBHOOK_URL != ''  # Slack WebhookURLãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
      with:
        status: ${{ steps.summary.outputs.overall }}
        channel: '#ci-cd'             # é€šçŸ¥å…ˆãƒãƒ£ãƒ³ãƒãƒ«
        fields: repo,message,commit,author,action,eventName,ref,workflow
        # æ§‹é€ åŒ–ã•ã‚ŒãŸSlackãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
        custom_payload: |
          {
            "text": "${{ steps.summary.outputs.icon }} ${{ steps.summary.outputs.message }}",
            "attachments": [
              {
                "color": "${{ steps.summary.outputs.overall == 'success' && 'good' || steps.summary.outputs.overall == 'partial' && 'warning' || 'danger' }}",
                "fields": [
                  {
                    "title": "Repository",
                    "value": "${{ github.repository }}",
                    "short": true
                  },
                  {
                    "title": "Branch/Tag",
                    "value": "${{ github.ref_name }}",
                    "short": true
                  },
                  {
                    "title": "Build Status",
                    "value": "${{ needs.build.result }}",
                    "short": true
                  },
                  {
                    "title": "Manifest Status",
                    "value": "${{ needs.create-manifest.result || 'skipped' }}",
                    "short": true
                  },
                  {
                    "title": "Platforms",
                    "value": "${{ env.PLATFORMS }}",
                    "short": true
                  },
                  {
                    "title": "Workflow",
                    "value": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>",
                    "short": true
                  }
                ]
              }
            ]
          }


  # ã€ã‚¸ãƒ§ãƒ–7ã€‘ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¬ãƒãƒ¼ãƒˆ - ãƒ“ãƒ«ãƒ‰æ€§èƒ½ã‚’è¨˜éŒ²ãƒ»åˆ†æ
  performance-report:
    runs-on: ubuntu-latest
    needs: [build, create-manifest]
    # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®pushã®å ´åˆã®ã¿å®Ÿè¡Œï¼ˆæœ¬æ ¼é‹ç”¨æ™‚ã®æ€§èƒ½æ¸¬å®šï¼‰
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write             # ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜ç”¨
    steps:
    - uses: actions/checkout@v4
    
    # ãƒ“ãƒ«ãƒ‰æ™‚é–“ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
    - name: ãƒ“ãƒ«ãƒ‰æ™‚é–“ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
      run: |
        # Markdownãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆ
        echo "# Build Performance Report" > performance-report.md
        echo "Generated: $(date -u)" >> performance-report.md
        echo "" >> performance-report.md
        echo "## Workflow Execution Time" >> performance-report.md
        echo "- **Total Duration**: ${{ github.run_id }} workflow" >> performance-report.md
        echo "- **Platforms Built**: ${{ env.PLATFORMS }}" >> performance-report.md
        echo "- **Cache Strategy**: Multi-layer (GHA + Registry)" >> performance-report.md
        echo "- **Optimization Features**: BuildKit, Parallel builds, Smart caching" >> performance-report.md
        
    # ç”Ÿæˆã—ãŸãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
    - name: ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜
      uses: actions/upload-artifact@v4
      with:
        name: performance-report     # ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆå
        path: performance-report.md  # ä¿å­˜ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«
        retention-days: 30          # 30æ—¥é–“ä¿æŒ
